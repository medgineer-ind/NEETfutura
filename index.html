<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NEET 2026 Futura Planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              'brand-cyan': {
                '100': '#E0FFFF', '200': '#B3FDFF', '300': '#80F9FF',
                '400': '#4DF4FF', '500': '#00EFFF', '600': '#00C3D3',
                '700': '#0097A7', '800': '#006B7B', '900': '#00404F',
              },
              'brand-blue': { '900': '#0A192F' }
            },
            boxShadow: {
              'glow-cyan': '0 0 15px rgba(0, 239, 255, 0.4)',
              'glow-cyan-light': '0 0 8px rgba(0, 239, 255, 0.3)',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            },
            animation: { fadeIn: 'fadeIn 0.5s ease-out forwards' },
          },
        },
      }
    </script>
    <style>
      /* Custom scrollbar for better aesthetics */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #0A192F; }
      ::-webkit-scrollbar-thumb { background: #0097A7; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #00EFFF; }
      .page-content { display: none; }
      .page-content.active { display: block; }
       /* Custom styles for sticky headers in tables */
      .sticky-subject-header {
        position: -webkit-sticky; /* For Safari */
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .sticky-chapter-header {
        position: -webkit-sticky;
        position: sticky;
        top: 2.5rem; /* Adjust based on subject header height */
        z-index: 5;
      }
    </style>
</head>
<body class="bg-gray-100 dark:bg-brand-blue-900 text-gray-800 dark:text-gray-200 font-sans transition-colors duration-500">
    <div class="absolute inset-0 -z-10 h-full w-full bg-white dark:bg-brand-blue-900 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px]"></div>

    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-white/10 dark:bg-black/20 backdrop-blur-lg border-b border-white/20">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="font-bold text-xl text-brand-cyan-500 tracking-wider">NEET Futura</span>
                </div>
                <div class="hidden md:flex items-center space-x-2">
                    <a href="#planner" class="nav-link flex items-center px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-brand-cyan-400 transition-all duration-300">Planner</a>
                    <a href="#test-planner" class="nav-link flex items-center px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-brand-cyan-400 transition-all duration-300">Test Planner</a>
                    <a href="#dashboard" class="nav-link flex items-center px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-brand-cyan-400 transition-all duration-300">Dashboard</a>
                    <a href="#settings" class="nav-link flex items-center px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-brand-cyan-400 transition-all duration-300">Settings</a>
                </div>
                 <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-gray-300 hover:text-brand-cyan-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="md:hidden hidden bg-black/30 backdrop-blur-lg">
            <a href="#planner" class="nav-link block px-4 py-2 text-sm text-gray-300 hover:text-brand-cyan-400">Planner</a>
            <a href="#test-planner" class="nav-link block px-4 py-2 text-sm text-gray-300 hover:text-brand-cyan-400">Test Planner</a>
            <a href="#dashboard" class="nav-link block px-4 py-2 text-sm text-gray-300 hover:text-brand-cyan-400">Dashboard</a>
            <a href="#settings" class="nav-link block px-4 py-2 text-sm text-gray-300 hover:text-brand-cyan-400">Settings</a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-12">
        <div id="page-planner" class="page-content"></div>
        <div id="page-test-planner" class="page-content"></div>
        <div id="page-dashboard" class="page-content"></div>
        <div id="page-settings" class="page-content"></div>
    </main>
    
    <!-- Theme Toggle Button -->
    <button id="theme-toggle" class="fixed bottom-5 right-5 z-50 w-12 h-12 bg-white/20 dark:bg-black/30 backdrop-blur-sm rounded-full flex items-center justify-center text-brand-cyan-500 shadow-glow-cyan hover:shadow-glow-cyan-light transition-all duration-300" aria-label="Toggle theme">
      <!-- Icon will be inserted by JS -->
    </button>
    
    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <script>
      // ====================================================================================
      // --- NEET FUTURA PLANNER - ALL-IN-ONE JAVASCRIPT LOGIC ---
      // ====================================================================================

      // --- 1. SYLLABUS DATA ---
      const syllabus = {
          Physics: { "Physics, Units & Measurements": ["Units of measurements", "System of Units", "SI units", "Fundamental and derived units", "Least count", "Significant figures", "Errors in measurement", "Dimensions of Physical Quantities", "Dimensional analysis"], "Kinematics": ["Frame of reference", "Motion in a straight line", "Position-time graph", "Speed and velocity", "Uniform and non-uniform motion", "Average speed and instantaneous velocity", "Uniformly accelerated motion", "Velocity-time graph", "Scalar and Vector quantities", "Position and displacement vectors", "Addition and subtraction of vectors", "Relative velocity", "Unit vector", "Resolution of a vector", "Scalar and Vector products", "Projectile motion", "Uniform circular motion"], "Laws of Motion": ["Concept of force & Inertia", "Newton's first law", "Momentum and Newton's second law", "Impulse & Newton's third law", "Conservation of linear momentum", "Equilibrium of concurrent forces", "Static and kinetic friction", "Laws of friction", "Rolling friction", "Dynamics of uniform circular motion", "Centripetal force"], "Work, Energy and Power": ["Work done by a constant and a variable force", "Kinetic energy & Work-energy theorem", "Power", "Potential energy & Potential energy of a spring", "Conservative and Non-conservative forces", "Conservation of mechanical energy", "Motion in a vertical circle", "Elastic and inelastic collisions"], "Rotational Motion": ["Centre of mass of a two-particle system", "Centre of mass of a rigid body", "Moment of a force & Torque", "Angular momentum & its conservation", "Equilibrium of rigid bodies", "Equations of rotational motion", "Moment of inertia & Radius of gyration", "Parallel and perpendicular axes theorems"], "Gravitation": ["Kepler's laws of planetary motion", "The universal law of gravitation", "Acceleration due to gravity and its variations", "Gravitational potential energy and potential", "Escape velocity & Orbital velocity", "Geo-stationary satellites"], "Properties of Solids and Liquids": ["Elastic behaviour & Stress-strain relationship", "Hooke's law, Young's modulus, Bulk modulus", "Pressure due to a fluid column", "Pascal's law and its applications", "Viscosity, Stokes' law, Terminal velocity", "Bernoulli's theorem and its applications", "Surface energy and surface tension", "Angle of contact & Capillary rise", "Heat, temperature, thermal expansion", "Specific heat capacity & Calorimetry", "Change of state & Latent heat", "Heat transfer: Conduction, convection, radiation"], "Thermodynamics": ["Thermal equilibrium & Zeroth law", "Heat, work and internal energy", "First law of thermodynamics", "Isothermal and adiabatic processes", "Second law of thermodynamics", "Heat engine and refrigerator"], "Kinetic Theory of Gases": ["Equation of state of a perfect gas", "Kinetic theory of gases & Concept of pressure", "RMS speed of gas molecules", "Degrees of freedom & Law of equipartition of energy", "Mean free path & Avogadro's number"], "Oscillations and Waves": ["Periodic motion, Period, frequency", "Simple harmonic motion (SHM) & its equation", "Energy in SHM", "Simple pendulum", "Damped and forced oscillations, Resonance", "Wave motion: Longitudinal and transverse waves", "Principle of superposition of waves", "Reflection and standing waves", "Beats & Doppler effect"], "Electrostatics": ["Electric charges and Coulomb's law", "Electric field and electric field lines", "Electric dipole & Electric flux", "Gauss's theorem and its applications", "Electric potential and potential difference", "Equipotential surfaces", "Electrical potential energy", "Conductors, insulators, and dielectrics", "Capacitors and capacitance", "Combination of capacitors", "Energy stored in a capacitor"], "Current Electricity": ["Electric current & Drift velocity", "Ohm's law, V-I characteristics", "Electrical energy and power", "Resistivity and conductivity", "Series and parallel combinations of resistors", "Internal resistance of a cell", "Kirchhoff's laws", "Wheatstone bridge & Metre bridge", "Potentiometer and its applications"], "Magnetic Effects of Current & Magnetism": ["Concept of magnetic field, Oersted's experiment", "Biot-Savart law and its application", "Ampere's law and its applications", "Force on a moving charge", "Force on a current-carrying conductor", "Torque on a current loop", "Moving coil galvanometer", "Earth's magnetic field", "Para-, dia- and ferro-magnetic substances"], "Electromagnetic Induction & AC": ["Faraday's laws, induced EMF and current", "Lenz's Law, Eddy currents", "Self and mutual induction", "Alternating currents, peak and RMS value", "Reactance and impedance", "LC oscillations, LCR series circuit, resonance", "Power in AC circuits", "AC generator and transformer"], "Electromagnetic Waves": ["Displacement current", "Electromagnetic wave characteristics", "Electromagnetic spectrum and its uses"], "Optics": ["Reflection and spherical mirrors", "Refraction, TIR and optical fibres", "Lenses, lens-maker's formula", "Power of a lens & Combination of lenses", "Refraction through a prism", "Optical instruments: Microscopes and telescopes", "Wave optics: Wavefront and Huygens' principle", "Interference, Young's double slit experiment", "Diffraction due to a single slit", "Polarisation and Brewster's law"], "Dual Nature of Matter and Radiation": ["Photoelectric effect", "Einstein's photoelectric equation", "Matter waves, de Broglie relation", "Davisson-Germer experiment"], "Atoms and Nuclei": ["Rutherford's model of atom", "Bohr model, energy levels, hydrogen spectrum", "Composition and size of nucleus", "Radioactivity, alpha, beta, gamma decay", "Mass-energy relation, mass defect", "Binding energy", "Nuclear fission and fusion"], "Electronic Devices": ["Energy bands in solids", "Semiconductor diode, I-V characteristics", "Diode as a rectifier", "Zener diode as a voltage regulator", "Junction transistor and its characteristics", "Transistor as an amplifier and oscillator", "Logic gates (OR, AND, NOT, NAND, NOR)"], },
          Chemistry: { "Some Basic Concepts of Chemistry": ["Laws of chemical combination", "Dalton's atomic theory", "Mole concept and molar mass", "Percentage composition, empirical and molecular formula", "Stoichiometry and calculations"], "Structure of Atom": ["Atomic number, isotopes and isobars", "Shells and subshells", "Dual nature of matter and light", "de Broglie's relationship", "Heisenberg uncertainty principle", "Quantum numbers & Orbitals", "Aufbau principle, Pauli exclusion principle, Hund's rule", "Electronic configuration of atoms"], "Classification of Elements and Periodicity": ["Modern periodic law", "Periodic trends in properties", "Atomic and ionic radii", "Ionization enthalpy", "Electron gain enthalpy", "Electronegativity, valence"], "Chemical Bonding and Molecular Structure": ["Valence electrons, ionic and covalent bond", "Bond parameters & Lewis structure", "VSEPR theory", "Valence bond theory & Hybridization", "Molecular orbital theory", "Hydrogen bond"], "Chemical Thermodynamics": ["Systems and surroundings", "First law of thermodynamics", "Internal energy and enthalpy", "Hess's law", "Enthalpy of bond dissociation, combustion, formation", "Second law of thermodynamics", "Gibbs energy change", "Third law of thermodynamics"], "Equilibrium": ["Law of chemical equilibrium, equilibrium constant", "Le Chatelier's principle", "Ionic equilibrium", "Acids and bases, pH concept", "Hydrolysis of salts", "Buffer solutions", "Solubility product & Common ion effect"], "Redox Reactions": ["Concept of oxidation and reduction", "Oxidation number", "Balancing redox reactions"], "Organic Chemistry: Basic Principles & Techniques": ["IUPAC nomenclature", "Electronic displacements: inductive, electromeric, resonance", "Homolytic and heterolytic fission", "Electrophiles and nucleophiles", "Types of organic reactions"], "Hydrocarbons": ["Alkanes: Nomenclature, isomerism, reactions", "Alkenes: Nomenclature, structure, preparation, reactions", "Alkynes: Nomenclature, structure, acidic character, reactions", "Aromatic hydrocarbons: Benzene, resonance, aromaticity", "Electrophilic substitution mechanism"], "Solutions": ["Types of solutions & Concentration units", "Solubility of gases in liquids", "Colligative properties", "Raoult's law", "Abnormal molecular mass & Vant Hoff factor"], "Electrochemistry": ["Redox reactions", "Conductance in electrolytic solutions", "Kohlrausch's Law & Electrolysis", "Galvanic cells & EMF of a cell", "Nernst equation", "Relation between Gibbs energy and EMF", "Fuel cells & Corrosion"], "Chemical Kinetics": ["Rate of a reaction", "Factors affecting reaction rates", "Order and molecularity of a reaction", "Rate law and specific rate constant", "Integrated rate equations and half-life", "Collision theory & Activation energy"], "d and f Block Elements": ["General introduction and electronic configuration", "Properties of transition metals", "Preparation of K2Cr2O7 and KMnO4", "Lanthanoids: configuration, oxidation states, contraction", "Actinoids: configuration, oxidation states"], "Coordination Compounds": ["Introduction, ligands, coordination number", "IUPAC nomenclature", "Bonding: Werner's, VBT, CFT", "Isomerism in coordination compounds", "Importance of coordination compounds"], "Haloalkanes and Haloarenes": ["Nomenclature and nature of Câ€“X bond", "Properties and reaction mechanisms", "Uses and environmental effects"], "Alcohols, Phenols and Ethers": ["Nomenclature and preparation methods", "Physical and chemical properties", "Identification of primary, secondary, tertiary alcohols", "Acidic nature of phenol", "Mechanism of dehydration"], "Aldehydes, Ketones and Carboxylic Acids": ["Nomenclature and nature of carbonyl group", "Preparation methods", "Physical and chemical properties", "Mechanism of nucleophilic addition", "Acidic nature of carboxylic acids"], "Organic Compounds Containing Nitrogen": ["Amines: Nomenclature, classification, properties", "Identification of primary, secondary, tertiary amines", "Diazonium salts: Preparation and reactions"], "Biomolecules": ["Carbohydrates: Classification and importance", "Proteins: Amino acids, peptide bond, structures", "Enzymes & Hormones", "Vitamins & Nucleic Acids (DNA, RNA)"], "Polymers": ["Classification: Natural and synthetic", "Methods of polymerization", "Important polymers and their uses"], "Chemistry in Everyday Life": ["Chemicals in medicines: Analgesics, antibiotics etc.", "Chemicals in food: Preservatives, sweetening agents", "Cleansing agents: Soaps and detergents"], },
          Botany: { "The Living World": ["What is living?", "Biodiversity & Taxonomy", "Concept of species and taxonomical hierarchy", "Binomial nomenclature"], "Biological Classification": ["Five kingdom classification", "Monera, Protista and Fungi", "Lichens, Viruses and Viroids"], "Plant Kingdom": ["Algae & Bryophytes", "Pteridophytes & Gymnosperms", "Angiosperms", "Plant life cycles and alternation of generations"], "Morphology of Flowering Plants": ["Root, Stem, Leaf morphology and modifications", "Inflorescence, Flower, Fruit and Seed"], "Anatomy of Flowering Plants": ["Plant Tissues", "Anatomy of Dicotyledonous and Monocotyledonous plants", "Secondary growth"], "Cell: The Unit of Life": ["Cell theory", "Prokaryotic and Eukaryotic cells", "Cell organelles: structure and function", "Endomembrane system, Mitochondria, Plastids", "Nucleus and Chromosomes"], "Cell Cycle and Cell Division": ["Cell cycle", "Mitosis and its stages", "Meiosis and its stages", "Significance of Mitosis and Meiosis"], "Transport in Plants": ["Means of transport", "Plant-water relations: Osmosis, Plasmolysis", "Long distance transport of water", "Transpiration", "Uptake and translocation of mineral nutrients", "Phloem transport: Mass flow hypothesis"], "Mineral Nutrition": ["Essential minerals: Macro and micronutrients", "Role and deficiency symptoms of minerals", "Nitrogen cycle and nitrogen fixation"], "Photosynthesis in Higher Plants": ["Site of photosynthesis & Pigments involved", "Photochemical and biosynthetic phases", "Cyclic and non-cyclic photophosphorylation", "Chemiosmotic hypothesis", "C3 and C4 pathways", "Factors affecting photosynthesis"], "Respiration in Plants": ["Cellular respiration: Glycolysis", "Fermentation", "TCA cycle and electron transport system (ETS)", "Amphibolic pathways & Respiratory quotient"], "Plant Growth and Development": ["Phases of plant growth", "Plant growth regulators: Auxin, Gibberellin, Cytokinin, etc.", "Photoperiodism & Vernalisation", "Seed germination and dormancy"], "Reproduction in Organisms": ["Asexual Reproduction", "Sexual Reproduction"], "Sexual Reproduction in Flowering Plants": ["Flower structure", "Development of male and female gametophytes", "Pollination: types and agencies", "Double fertilization", "Post-fertilization events: Endosperm, embryo, seed, fruit"], "Principles of Inheritance and Variation": ["Mendelian Inheritance & Deviations from Mendelism", "Incomplete dominance, Co-dominance, Multiple alleles", "Chromosome theory of inheritance", "Sex determination", "Linkage and crossing over", "Mendelian and Chromosomal disorders"], "Molecular Basis of Inheritance": ["Structure of DNA and RNA", "DNA packaging & DNA replication", "Central dogma: Transcription and Translation", "Genetic code", "Gene expression and regulation: Lac Operon", "Human Genome Project & DNA fingerprinting"], "Strategies for Enhancement in Food Production": ["Plant breeding", "Tissue culture", "Single cell protein (SCP)", "Biofortification"], "Microbes in Human Welfare": ["Microbes in household food processing and industry", "Sewage treatment", "Microbes as biocontrol agents and biofertilizers"], "Biotechnology: Principles and Processes": ["Genetic engineering (Recombinant DNA technology)", "Tools and processes of RDT"], "Biotechnology and Its Applications": ["Application in health and agriculture", "Genetically modified (GM) organisms: Bt crops", "Biosafety issues: Biopiracy and patents"], "Organisms and Populations": ["Organisms and its Environment", "Population interactions", "Population attributes"], "Ecosystem": ["Ecosystem components, productivity, decomposition", "Energy flow & Ecological pyramids", "Nutrient cycling (Carbon and Phosphorous)"], "Biodiversity and Conservation": ["Concept and patterns of biodiversity", "Importance and loss of biodiversity", "Biodiversity conservation strategies"], "Environmental Issues": ["Air and water pollution and their control", "Solid waste management", "Greenhouse effect and global warming", "Ozone depletion & Deforestation"], },
          Zoology: { "Animal Kingdom": ["Basis of classification", "Classification of Non-chordates (Phyla)", "Classification of Chordates (Classes)", "Salient features and examples"], "Structural Organisation in Animals": ["Animal tissues: Epithelial, Connective, Muscular, Neural", "Morphology and anatomy of Cockroach"], "Biomolecules": ["Proteins and Amino acids", "Carbohydrates", "Lipids", "Nucleic Acids", "Enzymes: types, properties, action"], "Digestion and Absorption": ["Alimentary canal and digestive glands", "Digestion of food and role of enzymes", "Absorption and assimilation", "Nutritional and digestive disorders"], "Breathing and Exchange of Gases": ["Human respiratory system", "Mechanism of breathing", "Exchange and transport of gases", "Regulation of respiration & Respiratory volumes", "Disorders of respiratory system"], "Body Fluids and Circulation": ["Blood, blood groups, coagulation", "Lymph and its function", "Human circulatory system, Heart structure", "Cardiac cycle, ECG, Double circulation", "Disorders of circulatory system"], "Excretory Products and their Elimination": ["Modes of excretion", "Human excretory system: structure and function", "Urine formation & Osmoregulation", "Regulation of kidney function", "Role of other organs in excretion", "Disorders of excretory system"], "Locomotion and Movement": ["Types of movement", "Muscle, skeletal muscle, muscle contraction", "Skeletal system and its functions", "Joints & Disorders of muscular and skeletal system"], "Neural Control and Coordination": ["Neuron and nerves", "Human nervous system (CNS, PNS)", "Generation and conduction of nerve impulse", "Sense organs: Eye and Ear"], "Chemical Coordination and Integration": ["Endocrine glands and hormones", "Human endocrine system", "Mechanism of hormone action", "Hypoactivity and hyperactivity related disorders"], "Human Reproduction": ["Male and female reproductive systems", "Gametogenesis (Spermatogenesis & Oogenesis)", "Menstrual cycle", "Fertilisation, implantation, pregnancy", "Parturition and lactation"], "Reproductive Health": ["Need for reproductive health", "Sexually transmitted diseases (STDs)", "Birth control methods", "Infertility and assisted reproductive technologies (ART)"], "Human Health and Disease": ["Common diseases in humans", "Pathogens and parasites", "Immunology: Basic concepts, vaccines", "Cancer, HIV and AIDS", "Drugs and alcohol abuse"], "Evolution": ["Origin of life & Evidences for evolution", "Darwinism & Modern synthetic theory", "Mechanism of evolution: Variation, Natural selection", "Hardy-Weinberg principle", "Adaptive Radiation & Human evolution"], "Animal Husbandry": ["Management of farms and farm animals", "Animal breeding", "Apiculture (Bee-keeping)"], },
      };

      // --- 2. STATE MANAGEMENT ---
      const appState = {
        tasks: [],
        testPlans: [],
        theme: 'dark',
        currentPage: 'planner',
        charts: {},
      };

      function loadState() {
        try {
          appState.tasks = JSON.parse(localStorage.getItem('tasks')) || [];
          appState.testPlans = JSON.parse(localStorage.getItem('testPlans')) || [];
          appState.theme = localStorage.getItem('theme') || 'dark';
        } catch (e) {
          console.error("Error loading state from localStorage", e);
        }
      }

      function saveTasks() {
        localStorage.setItem('tasks', JSON.stringify(appState.tasks));
      }
      
      function saveTestPlans() {
        localStorage.setItem('testPlans', JSON.stringify(appState.testPlans));
      }
      
      function saveTheme() {
          localStorage.setItem('theme', appState.theme);
      }

      // --- 3. UTILITY FUNCTIONS ---
      function calculateProgress(tasks) {
          const createEmptyStats = () => ({ total: 0, completed: 0, completionRate: 0, avgDifficulty: 0, avgAccuracy: 0, difficulties: [], accuracies: [] });
          const stats = { totalTasks: tasks.length, completedTasks: 0, completionRate: 0, subjects: {} };
          
          ['Physics', 'Chemistry', 'Botany', 'Zoology'].forEach(subjectName => {
              stats.subjects[subjectName] = { ...createEmptyStats(), chapters: {} };
              Object.keys(syllabus[subjectName]).forEach(chapterName => {
                  stats.subjects[subjectName].chapters[chapterName] = { ...createEmptyStats(), microtopics: {} };
                  syllabus[subjectName][chapterName].forEach(microtopicName => {
                      stats.subjects[subjectName].chapters[chapterName].microtopics[microtopicName] = createEmptyStats();
                  });
              });
          });

          tasks.forEach(task => {
              const subject = stats.subjects[task.subject];
              const chapter = subject?.chapters[task.chapter];
              const microtopic = chapter?.microtopics[task.microtopic];
              if (!subject || !chapter || !microtopic) return;

              subject.total++;
              chapter.total++;
              microtopic.total++;

              if (task.status === 'Completed') {
                  subject.completed++;
                  chapter.completed++;
                  microtopic.completed++;
                  if (task.difficulty) {
                      subject.difficulties.push(task.difficulty);
                      chapter.difficulties.push(task.difficulty);
                      microtopic.difficulties.push(task.difficulty);
                  }
                  if (task.totalQuestions > 0) {
                      const accuracy = (task.correctAnswers / task.totalQuestions) * 100;
                      subject.accuracies.push(accuracy);
                      chapter.accuracies.push(accuracy);
                      microtopic.accuracies.push(accuracy);
                  }
              }
          });

          stats.completedTasks = tasks.filter(t => t.status === 'Completed').length;
          if (stats.totalTasks > 0) {
            stats.completionRate = (stats.completedTasks / stats.totalTasks) * 100;
          }

          Object.values(stats.subjects).forEach(subject => {
              Object.values(subject.chapters).forEach(chapter => {
                  Object.values(chapter.microtopics).forEach(microtopic => {
                      if (microtopic.total > 0) microtopic.completionRate = (microtopic.completed / microtopic.total) * 100;
                      if (microtopic.difficulties.length > 0) microtopic.avgDifficulty = microtopic.difficulties.reduce((a, b) => a + b, 0) / microtopic.difficulties.length;
                      if (microtopic.accuracies.length > 0) microtopic.avgAccuracy = microtopic.accuracies.reduce((a, b) => a + b, 0) / microtopic.accuracies.length;
                  });
                  if (chapter.total > 0) chapter.completionRate = (chapter.completed / chapter.total) * 100;
                  if (chapter.difficulties.length > 0) chapter.avgDifficulty = chapter.difficulties.reduce((a, b) => a + b, 0) / chapter.difficulties.length;
                  if (chapter.accuracies.length > 0) chapter.avgAccuracy = chapter.accuracies.reduce((a, b) => a + b, 0) / chapter.accuracies.length;
              });
              if (subject.total > 0) subject.completionRate = (subject.completed / subject.total) * 100;
              if (subject.difficulties.length > 0) subject.avgDifficulty = subject.difficulties.reduce((a, b) => a + b, 0) / subject.difficulties.length;
              if (subject.accuracies.length > 0) subject.avgAccuracy = subject.accuracies.reduce((a, b) => a + b, 0) / subject.accuracies.length;
          });
          return stats;
      }

      function analyzeSyllabusForTest(testSyllabus, progress) {
          const allTopics = [];
          Object.keys(testSyllabus).forEach(subjectName => {
              const chapters = testSyllabus[subjectName];
              if (chapters) {
                  chapters.forEach(chapterName => {
                      const chapterData = progress.subjects[subjectName]?.chapters[chapterName];
                      if (chapterData) {
                          Object.entries(chapterData.microtopics).forEach(([microtopicName, microtopicData]) => {
                              if (microtopicData.completed > 0) {
                                  allTopics.push({ subject: subjectName, chapter: chapterName, microtopic: microtopicName, avgDifficulty: microtopicData.avgDifficulty, avgAccuracy: microtopicData.avgAccuracy });
                              }
                          });
                      }
                  });
              }
          });
          const weakTopics = allTopics.filter(t => t.avgDifficulty > 3.5 || t.avgAccuracy < 60).sort((a, b) => a.avgAccuracy - b.avgAccuracy || b.avgDifficulty - a.avgDifficulty);
          const strongTopics = allTopics.filter(t => t.avgDifficulty <= 2.5 && t.avgAccuracy >= 85).sort((a, b) => b.avgAccuracy - a.avgAccuracy || a.avgDifficulty - b.avgDifficulty);
          return { weakTopics, strongTopics };
      }


      // --- 4. MODAL & UI HELPERS ---
      function showModal(title, contentHTML) {
        const modalContainer = document.getElementById('modal-container');
        const modalHTML = `
          <div id="app-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] animate-fadeIn">
            <div class="bg-brand-blue-900/80 border border-brand-cyan-700 rounded-lg shadow-glow-cyan p-6 w-full max-w-lg m-4" id="modal-content">
              <h3 class="text-xl font-bold text-brand-cyan-400 mb-4">${title}</h3>
              ${contentHTML}
            </div>
          </div>
        `;
        modalContainer.innerHTML = modalHTML;

        document.getElementById('app-modal').addEventListener('click', (e) => {
            if (e.target.id === 'app-modal') {
                closeModal();
            }
        });
      }

      function closeModal() {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.innerHTML = '';
      }

      const ICONS = {
        sun: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
        moon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
        trophy: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-yellow-400"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
        clock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
      };

      // --- 5. RENDER FUNCTIONS ---
      function renderAll() {
        renderPlanner();
        renderTestPlanner();
        renderDashboard();
        renderSettings();
        navigateTo(appState.currentPage, true);
      }

      // --- PLANNER PAGE ---
      function renderPlanner() {
          const container = document.getElementById('page-planner');
          
          const upcomingTestTopics = new Set();
          appState.testPlans.filter(p => p.status === 'Upcoming').forEach(p => {
              p.topicStatus.forEach(topic => {
                  upcomingTestTopics.add(`${topic.subject}-${topic.chapter}-${topic.microtopic}`);
              });
          });
          const isTaskForTest = (task) => upcomingTestTopics.has(`${task.subject}-${task.chapter}-${task.microtopic}`);

          // Upcoming Tests Section
          const upcomingTests = appState.testPlans.filter(p => p.status === 'Upcoming');
          let deadlinesHTML = '';
          if (upcomingTests.length > 0) {
              const testsWithProgress = upcomingTests.map(test => {
                  const totalTopics = test.topicStatus.length;
                  const preparedTopics = totalTopics > 0 ? test.topicStatus.filter(t => t.revisionDifficulty || t.practiceAttempts.length > 0).length : 0;
                  const progress = totalTopics > 0 ? (preparedTopics / totalTopics) * 100 : 0;
                  const today = new Date(); today.setHours(0, 0, 0, 0);
                  const testDate = new Date(new Date(test.date).toLocaleString("en-US", {timeZone: "UTC"})); testDate.setHours(0, 0, 0, 0);
                  const daysLeft = Math.max(0, Math.ceil((testDate.getTime() - today.getTime()) / (1000 * 3600 * 24)));
                  return { ...test, daysLeft, progress };
              }).sort((a,b) => a.daysLeft - b.daysLeft);

              deadlinesHTML = `
                <div class="bg-white/10 dark:bg-black/20 backdrop-blur-md border border-white/20 rounded-lg shadow-lg animate-fadeIn p-6 mb-8">
                  <h2 class="text-2xl font-bold text-brand-cyan-400 mb-4">Upcoming Test Deadlines</h2>
                  <div class="space-y-4">
                  ${testsWithProgress.map(test => `
                    <div class="p-4 bg-black/20 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold">${test.name}</span>
                            <span class="flex items-center text-sm text-yellow-300 gap-1">${ICONS.clock} ${test.daysLeft} days left</span>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs text-gray-400 mb-1">
                                <span>Preparation Progress</span>
                                <span>${test.progress.toFixed(0)}%</span>
                            </div>
                            <div class="w-full bg-black/30 rounded-full h-2.5">
                                <div class="bg-brand-cyan-500 h-2.5 rounded-full" style="width: ${test.progress}%"></div>
                            </div>
                        </div>
                    </div>
                  `).join('')}
                  </div>
                </div>
              `;
          }

          // Task List
          const groupedTasks = appState.tasks.reduce((acc, task) => {
              const date = new Date(new Date(task.date).toLocaleString("en-US", { timeZone: "UTC" })).toDateString();
              if (!acc[date]) acc[date] = [];
              acc[date].push(task);
              return acc;
          }, {});

          let tasksHTML = '<p class="text-center text-gray-400">Your planner is empty. Add a new task to get started!</p>';
          if (appState.tasks.length > 0) {
              tasksHTML = Object.entries(groupedTasks).map(([date, dateTasks]) => `
                <div>
                  <h3 class="font-semibold text-lg mb-2 border-b border-white/20 pb-1">${date}</h3>
                  <div class="space-y-2">
                    ${dateTasks.map(task => {
                      const forTestIcon = isTaskForTest(task) ? `<span title="This topic is in an upcoming test">${ICONS.trophy}</span>` : '';
                      return `
                        <div class="p-4 bg-white/5 dark:bg-black/20 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div class="flex items-center gap-4">
                                <!-- Icon here -->
                                <div>
                                    <div class="flex items-center gap-2 font-semibold">${forTestIcon} ${task.name}</div>
                                    <p class="text-xs text-gray-400">${task.microtopic} (${task.subject} > ${task.chapter})</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 self-end sm:self-center">
                                ${task.status === 'Pending' 
                                    ? `<button class="task-complete-btn text-xs px-2 py-1 rounded-md font-semibold bg-white/20 hover:bg-white/30 text-white" data-task-id="${task.id}">Complete</button>` 
                                    : `<span class="text-xs font-bold text-green-400 px-2 py-1 bg-green-500/20 rounded-full">Completed</span>`
                                }
                                <button class="task-delete-btn p-1 text-gray-400 hover:text-red-400" data-task-id="${task.id}">&times;</button>
                            </div>
                        </div>
                      `}).join('')}
                  </div>
                </div>
              `).join('');
          }

          container.innerHTML = `
            <div class="bg-white/10 dark:bg-black/20 backdrop-blur-md border border-white/20 rounded-lg shadow-lg animate-fadeIn p-6 mb-8">
              <h2 class="text-2xl font-bold text-brand-cyan-400 mb-4">Plan a New Task</h2>
              <form id="task-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="lg:col-span-3">
                    <label class="block text-sm font-medium mb-1">Task Name</label>
                    <input type="text" id="task-name" placeholder="e.g., Solve 50 MCQs" required class="w-full bg-white/10 dark:bg-black/30 border border-white/20 rounded-md px-3 py-2 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-brand-cyan-500">
                </div>
                <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Subject</label>
                        <select id="task-subject" class="w-full bg-white/10 dark:bg-black/30 border border-white/20 rounded-md px-3 py-2 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-brand-cyan-500"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Chapter</label>
                        <select id="task-chapter" class="w-full bg-white/10 dark:bg-black/30 border border-white/20 rounded-md px-3 py-2 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-brand-cyan-500"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Microtopic</label>
                        <select id="task-microtopic" class="w-full bg-white/10 dark:bg-black/30 border border-white/20 rounded-md px-3 py-2 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-brand-cyan-500"></select>
                    </div>
                </div>
                <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <label class="block text-sm font-medium mb-1">Task Type</label>
                      <select id="task-type" class="w-full bg-white/10 dark:bg-black/30 border border-white/20 rounded-md px-3 py-2 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-brand-cyan-500">
                          <option value="Study">Study</option>
                          <option value="Revision">Revision</option>
                          <option value="Practice">Practice</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-sm font-medium mb-1">Date</label>
                      <input type="date" id="task-date" value="${new Date().toISOString().split('T')[0]}" class="w-full bg-white/10 dark:bg-black/30 border border-white/20 rounded-md px-3 py-2 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-brand-cyan-500">
                    </div>
                    <div class="md:col-start-3 flex items-end">
                      <button type="submit" class="w-full px-4 py-2 rounded-md font-semibold transition-all duration-300 flex items-center justify-center gap-2 bg-brand-cyan-500 text-brand-blue-900 hover:bg-brand-cyan-400 shadow-glow-cyan-light hover:shadow-glow-cyan">Add Task</button>
                    </div>
                </div>
              </form>
            </div>
            ${deadlinesHTML}
            <h2 class="text-2xl font-bold text-brand-cyan-400 mb-4">Your Daily Tasks</h2>
            <div id="task-list" class="space-y-6">${tasksHTML}</div>
          `;

          populateDropdowns();
          attachPlannerListeners();
      }

      function populateDropdowns(subjectName = 'Physics', chapterName) {
          const subjectSelect = document.getElementById('task-subject');
          const chapterSelect = document.getElementById('task-chapter');
          const microtopicSelect = document.getElementById('task-microtopic');

          if (subjectSelect.options.length === 0) {
              subjectSelect.innerHTML = Object.keys(syllabus).map(s => `<option value="${s}" ${s === subjectName ? 'selected' : ''}>${s}</option>`).join('');
          }
          
          const currentSubject = subjectSelect.value;
          const chapters = Object.keys(syllabus[currentSubject]);
          chapterSelect.innerHTML = chapters.map(c => `<option value="${c}" ${c === chapterName ? 'selected' : ''}>${c}</option>`).join('');

          const currentChapter = chapterSelect.value;
          const microtopics = syllabus[currentSubject][currentChapter] || [];
          microtopicSelect.innerHTML = microtopics.map(m => `<option value="${m}">${m}</option>`).join('');
      }
      
      // --- TEST PLANNER PAGE ---
      function renderTestPlanner() {
          const container = document.getElementById('page-test-planner');
          
          const { upcomingTests, completedTests } = appState.testPlans.reduce((acc, test) => {
              (test.status === 'Upcoming' ? acc.upcomingTests : acc.completedTests).push(test);
              return acc;
          }, { upcomingTests: [], completedTests: [] });

          upcomingTests.sort((a,b) => new Date(a.date).getTime() - new Date(b.date).getTime());
          completedTests.sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime());

          const upcomingHTML = upcomingTests.length > 0 ? upcomingTests.map(test => {
              const groupedTopics = test.topicStatus.reduce((acc, topic) => {
                  if (!acc[topic.subject]) acc[topic.subject] = {};
                  if (!acc[topic.subject][topic.chapter]) acc[topic.subject][topic.chapter] = [];
                  acc[topic.subject][topic.chapter].push(topic);
                  return acc;
              }, {});

              const prepChecklistHTML = `
                <div class="w-full bg-black/20 p-3 rounded-lg max-h-[50vh] overflow-y-auto mt-4">
                  <table class="w-full text-xs">
                    <thead class="sticky top-0 bg-black/30 z-20">
                      <tr class="text-left text-gray-400 border-b border-white/20">
                        <th class="py-2 px-3 w-2/5">Topic</th>
                        <th class="py-2 px-3 text-center w-1/5">Daily Performance</th>
                        <th class="py-2 px-3 text-center w-1/5">Test Revision</th>
                        <th class="py-2 px-3 text-center w-1/5">Test Practice</th>
                      </tr>
                    </thead>
                    <tbody>
                    ${Object.keys(groupedTopics).map(subject => `
                      <tr class="sticky-subject-header bg-brand-cyan-900/50 backdrop-blur-sm">
                        <th colspan="4" class="py-2 px-3 text-left font-bold text-brand-cyan-400 text-sm uppercase tracking-wider">${subject}</th>
                      </tr>
                      ${Object.keys(groupedTopics[subject]).map(chapter => `
                        <tr class="sticky-chapter-header bg-black/40">
                          <td colspan="4" class="py-1.5 px-3 font-semibold text-gray-300 pl-6">${chapter}</td>
                        </tr>
                        ${groupedTopics[subject][chapter].map(topic => {
                            const progress = calculateProgress(appState.tasks);
                            const dailyStats = progress.subjects[topic.subject]?.chapters[topic.chapter]?.microtopics[topic.microtopic];
                            const dailyPerfHTML = (dailyStats && dailyStats.completed > 0) ? `<div><span class="block">Diff: ${dailyStats.avgDifficulty.toFixed(1)}</span><span>Acc: ${dailyStats.avgAccuracy.toFixed(0)}%</span></div>` : `<span class="text-gray-500">No Data</span>`;
                            
                            const avgAccuracy = topic.practiceAttempts.length > 0 ? (topic.practiceAttempts.reduce((s, a) => s + a.correctAnswers, 0) / topic.practiceAttempts.reduce((s, a) => s + a.totalQuestions, 0)) * 100 : null;
                            const practiceHTML = `
                              ${avgAccuracy !== null ? `<span class="font-bold block mb-1 ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 50 ? 'text-yellow-400' : 'text-red-400'}">Acc: ${avgAccuracy.toFixed(0)}%</span>` : ''}
                              <button class="test-practice-btn px-2 py-1 rounded-md text-xs bg-transparent hover:bg-white/10 text-gray-300" data-testid="${test.id}" data-subject="${topic.subject}" data-chapter="${topic.chapter}" data-microtopic="${topic.microtopic}">Practice</button>
                            `;
                            const revisionHTML = topic.revisionDifficulty ? `<span class="font-bold">Diff: ${topic.revisionDifficulty}/5</span>` : `<button class="test-revise-btn px-2 py-1 rounded-md text-xs bg-transparent hover:bg-white/10 text-gray-300" data-testid="${test.id}" data-subject="${topic.subject}" data-chapter="${topic.chapter}" data-microtopic="${topic.microtopic}">Revise</button>`;
                            return `<tr class="border-b border-white/10 hover:bg-white/5">
                                <td class="py-1.5 px-3 pl-8">${topic.microtopic}</td>
                                <td class="py-1.5 text-center">${dailyPerfHTML}</td>
                                <td class="py-1.5 text-center">${revisionHTML}</td>
                                <td class="py-1.5 text-center">${practiceHTML}</td>
                              </tr>`;
                        }).join('')}
                      `).join('')}
                    `).join('')}
                    </tbody>
                  </table>
                </div>
              `;

              return `
                <div class="bg-white/10 dark:bg-black/20 backdrop-blur-md border border-white/20 rounded-lg shadow-lg p-4 flex flex-col gap-4">
                  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center w-full">
                    <div>
                      <p class="font-semibold">${test.name}</p>
                      <p class="text-sm text-gray-400">${new Date(test.date).toDateString()}</p>
                    </div>
                    <div class="flex items-center gap-2 self-end sm:self-center">
                      <button class="test-prep-toggle-btn px-2 py-1 rounded-md font-semibold text-xs bg-white/20 hover:bg-white/30 text-white" data-testid="${test.id}">Toggle Prep</button>
                      <button class="test-complete-btn px-2 py-1 rounded-md font-semibold text-xs bg-white/20 hover:bg-white/30 text-white" data-testid="${test.id}">Complete</button>
                      <button class="test-delete-btn p-1 text-gray-400 hover:text-red-400" data-testid="${test.id}">&times;</button>
                    </div>
                  </div>
                  <div id="prep-${test.id}" class="hidden">${prepChecklistHTML}</div>
                </div>`;
          }).join('') : '<div class="bg-white/10 dark:bg-black/20 p-6 text-center text-gray-400 rounded-lg">No upcoming tests. Plan one now!</div>';
          
          const completedHTML = completedTests.length > 0 ? completedTests.map(test => `
            <div class="bg-white/10 dark:bg-black/20 p-4 rounded-lg flex justify-between items-center">
                <div>
                  <p class="font-semibold">${test.name} - <span class="text-brand-cyan-400 font-bold">${test.analysis?.marksObtained} / ${test.analysis?.totalMarks}</span></p>
                  <p class="text-sm text-gray-400">${new Date(test.date).toDateString()}</p>
                </div>
                <div class="flex items-center gap-2">
                  <button class="test-view-analysis-btn px-2 py-1 rounded-md font-semibold text-xs bg-white/20 hover:bg-white/30 text-white" data-testid="${test.id}">View Analysis</button>
                  <button class="test-delete-btn p-1 text-gray-400 hover:text-red-400" data-testid="${test.id}">&times;</button>
                </div>
            </div>
          `).join('') : '<div class="bg-white/10 dark:bg-black/20 p-6 text-center text-gray-400 rounded-lg">You haven\'t completed any tests yet.</div>';

          container.innerHTML = `
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-brand-cyan-400">Test Planner</h1>
                <button id="create-test-btn" class="px-4 py-2 rounded-md font-semibold bg-brand-cyan-500 text-brand-blue-900 hover:bg-brand-cyan-400">Plan a Test</button>
            </div>
            <section>
              <h2 class="text-2xl font-bold text-brand-cyan-400 mb-4">Upcoming Tests</h2>
              <div class="space-y-4">${upcomingHTML}</div>
            </section>
            <section class="mt-12">
              <h2 class="text-2xl font-bold text-brand-cyan-400 mb-4">Completed Tests</h2>
              <div class="space-y-4">${completedHTML}</div>
            </section>
          `;
          attachTestPlannerListeners();
      }

      // --- DASHBOARD PAGE ---
      function renderDashboard() {
          const container = document.getElementById('page-dashboard');
          const stats = calculateProgress(appState.tasks);

          const tableRowsHTML = Object.entries(stats.subjects).filter(([,data]) => data.total > 0).map(([subjectName, subjectData]) => {
              const chapterRows = Object.entries(subjectData.chapters).filter(([,data]) => data.total > 0).map(([chapterName, chapterData]) => {
                  const microtopicRows = Object.entries(chapterData.microtopics).filter(([,data]) => data.total > 0).map(([microtopicName, microtopicData]) => `
                    <tr class="bg-black/20 text-gray-400">
                        <td class="py-2 px-3 pl-16 text-xs">${microtopicName}</td>
                        <td class="py-2 px-3 text-center">${microtopicData.completed} / ${microtopicData.total}</td>
                        <td class="py-2 px-3 text-center">${microtopicData.completionRate.toFixed(1)}%</td>
                        <td class="py-2 px-3 text-center">${microtopicData.avgDifficulty > 0 ? microtopicData.avgDifficulty.toFixed(2) : 'N/A'}</td>
                        <td class="py-2 px-3 text-center">${microtopicData.avgAccuracy > 0 ? `${microtopicData.avgAccuracy.toFixed(1)}%` : 'N/A'}</td>
                    </tr>
                  `).join('');
                  return `
                    <tr class="border-b border-white/10 bg-black/10 hover:bg-black/20">
                      <td class="p-3 pl-10 font-medium">${chapterName}</td>
                      <td class="p-3 text-center">${chapterData.completed} / ${chapterData.total}</td>
                      <td class="p-3 text-center">${chapterData.completionRate.toFixed(1)}%</td>
                      <td class="p-3 text-center">${chapterData.avgDifficulty > 0 ? chapterData.avgDifficulty.toFixed(2) : 'N/A'}</td>
                      <td class="p-3 text-center">${chapterData.avgAccuracy > 0 ? `${chapterData.avgAccuracy.toFixed(1)}%` : 'N/A'}</td>
                    </tr>
                    ${microtopicRows}
                  `;
              }).join('');

              return `
                <tr class="border-b border-white/10 bg-white/5">
                  <td class="p-3 font-semibold" style="color: ${{'Physics':'#00EFFF','Chemistry':'#8884d8','Botany':'#82ca9c','Zoology':'#ffc658'}[subjectName]}">${subjectName}</td>
                  <td class="p-3 text-center">${subjectData.completed} / ${subjectData.total}</td>
                  <td class="p-3 text-center">${subjectData.completionRate.toFixed(1)}%</td>
                  <td class="p-3 text-center">${subjectData.avgDifficulty > 0 ? subjectData.avgDifficulty.toFixed(2) : 'N/A'}</td>
                  <td class="p-3 text-center">${subjectData.avgAccuracy > 0 ? `${subjectData.avgAccuracy.toFixed(1)}%` : 'N/A'}</td>
                </tr>
                ${chapterRows}
              `;
          }).join('');

          container.innerHTML = `
            <div class="space-y-8">
              <h1 class="text-3xl font-bold text-brand-cyan-400">Dashboard</h1>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-white/10 p-6 rounded-lg"><h3 class="text-gray-400">Overall Completion</h3><p class="text-3xl font-bold text-brand-cyan-400 mt-2">${stats.completionRate.toFixed(1)}%</p></div>
                <div class="bg-white/10 p-6 rounded-lg"><h3 class="text-gray-400">Tasks Completed</h3><p class="text-3xl font-bold text-brand-cyan-400 mt-2">${stats.completedTasks}</p></div>
                <div class="bg-white/10 p-6 rounded-lg"><h3 class="text-gray-400">Pending Tasks</h3><p class="text-3xl font-bold text-brand-cyan-400 mt-2">${stats.totalTasks - stats.completedTasks}</p></div>
              </div>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white/10 p-6 rounded-lg"><h3 class="text-lg font-semibold text-brand-cyan-400 mb-4">Completed Tasks by Subject</h3><canvas id="completionChart"></canvas></div>
                <div class="bg-white/10 p-6 rounded-lg"><h3 class="text-lg font-semibold text-brand-cyan-400 mb-4">Performance by Subject</h3><canvas id="performanceChart"></canvas></div>
              </div>
              <div class="bg-white/10 p-6 rounded-lg">
                <h3 class="text-lg font-semibold text-brand-cyan-400 mb-4">Detailed Breakdown</h3>
                <div class="overflow-x-auto"><table class="w-full text-left text-sm">
                  <thead class="border-b border-white/20 text-xs uppercase text-gray-400"><tr><th class="p-3">Topic</th><th class="p-3 text-center">Completed / Total</th><th class="p-3 text-center">Completion %</th><th class="p-3 text-center">Avg. Difficulty</th><th class="p-3 text-center">Avg. Accuracy</th></tr></thead>
                  <tbody>${tableRowsHTML}</tbody>
                </table></div>
              </div>
            </div>
          `;
          renderCharts(stats);
      }
      
      function renderCharts(stats) {
          // Destroy old charts if they exist
          if (appState.charts.completion) appState.charts.completion.destroy();
          if (appState.charts.performance) appState.charts.performance.destroy();

          // Completion Chart
          const completionCtx = document.getElementById('completionChart').getContext('2d');
          const completionData = {
              labels: Object.keys(stats.subjects),
              datasets: [{
                  data: Object.values(stats.subjects).map(s => s.completed),
                  backgroundColor: ['#00EFFF', '#8884d8', '#82ca9c', '#ffc658'],
              }]
          };
          appState.charts.completion = new Chart(completionCtx, { type: 'pie', data: completionData, options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#e5e7eb' } } } } });

          // Performance Chart
          const performanceCtx = document.getElementById('performanceChart').getContext('2d');
          const performanceData = {
              labels: Object.keys(stats.subjects),
              datasets: [
                { label: 'Avg Accuracy (%)', data: Object.values(stats.subjects).map(s => s.avgAccuracy), backgroundColor: '#82ca9c', yAxisID: 'y' },
                { label: 'Avg Difficulty (1-5)', data: Object.values(stats.subjects).map(s => s.avgDifficulty * 20), backgroundColor: '#8884d8', yAxisID: 'y1' } // Scale difficulty
              ]
          };
          appState.charts.performance = new Chart(performanceCtx, { type: 'bar', data: performanceData, options: {
              responsive: true,
              scales: {
                  x: { ticks: { color: '#9ca3af' } },
                  y: { type: 'linear', display: true, position: 'left', min: 0, max: 100, ticks: { color: '#82ca9c', callback: (v) => `${v}%` } },
                  y1: { type: 'linear', display: true, position: 'right', min: 0, max: 100, grid: { drawOnChartArea: false }, ticks: { color: '#8884d8', callback: (v) => `${(v/20).toFixed(1)}` } }
              },
              plugins: { legend: { labels: { color: '#e5e7eb' } } }
          }});
      }

      // --- SETTINGS PAGE ---
      function renderSettings() {
          const container = document.getElementById('page-settings');
          container.innerHTML = `
            <div class="max-w-2xl mx-auto">
              <h1 class="text-3xl font-bold text-brand-cyan-400 mb-8">Settings</h1>
              <div class="bg-white/10 p-6 rounded-lg mb-8">
                <h2 class="text-xl font-semibold text-brand-cyan-500 mb-2">Data Management</h2>
                <div class="flex gap-4 mt-4">
                  <button id="export-btn" class="px-4 py-2 rounded-md font-semibold bg-white/20 hover:bg-white/30 text-white">Export Data</button>
                  <button id="import-btn" class="px-4 py-2 rounded-md font-semibold bg-white/20 hover:bg-white/30 text-white">Import Data</button>
                  <input type="file" id="import-file" class="hidden" accept="application/json">
                </div>
              </div>
              <div class="bg-white/10 p-6 rounded-lg">
                <h2 class="text-xl font-semibold text-red-400 mb-2">Danger Zone</h2>
                <button id="reset-btn" class="px-4 py-2 rounded-md font-semibold bg-red-500/80 hover:bg-red-500 text-white mt-4">Reset All Data</button>
              </div>
            </div>
          `;
          attachSettingsListeners();
      }

      // --- 6. EVENT LISTENERS ---
      
      function attachPlannerListeners() {
        // Form submission
        document.getElementById('task-form').addEventListener('submit', (e) => {
          e.preventDefault();
          const newTask = {
            id: crypto.randomUUID(),
            name: document.getElementById('task-name').value,
            subject: document.getElementById('task-subject').value,
            chapter: document.getElementById('task-chapter').value,
            microtopic: document.getElementById('task-microtopic').value,
            taskType: document.getElementById('task-type').value,
            date: document.getElementById('task-date').value,
            status: 'Pending',
          };
          appState.tasks.push(newTask);
          appState.tasks.sort((a,b) => new Date(a.date).getTime() - new Date(b.date).getTime());
          saveTasks();
          renderPlanner();
        });

        // Dropdown changes
        document.getElementById('task-subject').addEventListener('change', (e) => populateDropdowns(e.target.value));
        document.getElementById('task-chapter').addEventListener('change', (e) => populateDropdowns(document.getElementById('task-subject').value, e.target.value));
        
        // Task list buttons
        document.getElementById('task-list').addEventListener('click', (e) => {
          const target = e.target.closest('button');
          if (!target) return;
          
          const taskId = target.dataset.taskId;
          if (target.classList.contains('task-delete-btn')) {
            if (confirm('Are you sure you want to delete this task?')) {
              appState.tasks = appState.tasks.filter(t => t.id !== taskId);
              saveTasks();
              renderAll();
            }
          } else if (target.classList.contains('task-complete-btn')) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (task.taskType === 'Practice') {
              showModal(`Practice Feedback: ${task.name}`, `
                <form id="practice-feedback-form">
                  <div class="space-y-4"><label class="block">Total Questions</label><input type="number" id="totalQ" min="1" required class="w-full bg-black/30 p-2 rounded"></div>
                  <div class="space-y-4"><label class="block">Correct Answers</label><input type="number" id="correctQ" min="0" required class="w-full bg-black/30 p-2 rounded"></div>
                  <div class="flex justify-end gap-2 mt-4"><button type="submit" class="px-4 py-2 rounded bg-brand-cyan-500 text-black">Save</button></div>
                </form>
              `);
              document.getElementById('practice-feedback-form').addEventListener('submit', (ev) => {
                  ev.preventDefault();
                  task.status = 'Completed';
                  task.totalQuestions = parseInt(document.getElementById('totalQ').value);
                  task.correctAnswers = parseInt(document.getElementById('correctQ').value);
                  saveTasks();
                  renderAll();
                  closeModal();
              });
            } else { // Study or Revision
              showModal(`Complete: ${task.name}`, `
                <form id="study-feedback-form">
                  <label class="block mb-2">Difficulty (1: Easy - 5: Hard)</label>
                  <input type="range" id="difficulty" min="1" max="5" value="3" class="w-full">
                  <div class="flex justify-end gap-2 mt-4"><button type="submit" class="px-4 py-2 rounded bg-brand-cyan-500 text-black">Save</button></div>
                </form>
              `);
              document.getElementById('study-feedback-form').addEventListener('submit', (ev) => {
                  ev.preventDefault();
                  task.status = 'Completed';
                  task.difficulty = parseInt(document.getElementById('difficulty').value);
                  saveTasks();
                  renderAll();
                  closeModal();
              });
            }
          }
        });
      }

      function attachTestPlannerListeners() {
          document.getElementById('create-test-btn').addEventListener('click', () => {
              const progress = calculateProgress(appState.tasks);
              const syllabusCheckboxesHTML = Object.keys(syllabus).map(subject => `
                  <div>
                    <h4 class="font-bold mb-2">${subject}</h4>
                    <div class="space-y-1">
                      ${Object.keys(syllabus[subject]).map(chapter => `<label class="flex items-center text-sm"><input type="checkbox" class="mr-2 chapter-checkbox" data-subject="${subject}" data-chapter="${chapter}">${chapter}</label>`).join('')}
                    </div>
                  </div>
              `).join('');

              showModal('Plan a New Test', `
                <form id="create-test-form">
                  <input type="text" id="test-name" placeholder="Test Name" required class="w-full bg-black/30 p-2 rounded mb-2">
                  <input type="date" id="test-date" value="${new Date().toISOString().split('T')[0]}" class="w-full bg-black/30 p-2 rounded mb-4">
                  <h3 class="font-semibold text-brand-cyan-400 mb-2">Select Syllabus</h3>
                  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 max-h-60 overflow-y-auto p-2 bg-black/20 rounded-md mb-4">${syllabusCheckboxesHTML}</div>
                  <div id="topic-analysis-container"></div>
                  <div class="flex justify-end mt-4"><button type="submit" class="px-4 py-2 rounded bg-brand-cyan-500 text-black">Create Test</button></div>
                </form>
              `);

              document.querySelectorAll('.chapter-checkbox').forEach(cb => {
                  cb.addEventListener('change', () => {
                      const selectedSyllabus = {};
                      document.querySelectorAll('.chapter-checkbox:checked').forEach(checkedCb => {
                          const { subject, chapter } = checkedCb.dataset;
                          if (!selectedSyllabus[subject]) selectedSyllabus[subject] = [];
                          selectedSyllabus[subject].push(chapter);
                      });
                      const { weakTopics, strongTopics } = analyzeSyllabusForTest(selectedSyllabus, progress);
                      document.getElementById('topic-analysis-container').innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                          <div><h4 class="font-semibold text-red-400 mb-2">Weak Topics</h4><ul class="text-xs space-y-2">${weakTopics.map(t => `<li class="p-2 bg-red-500/10 rounded"><b>${t.microtopic}</b> (${t.chapter})</li>`).join('')}</ul></div>
                          <div><h4 class="font-semibold text-green-400 mb-2">Strong Topics</h4><ul class="text-xs space-y-2">${strongTopics.map(t => `<li class="p-2 bg-green-500/10 rounded"><b>${t.microtopic}</b> (${t.chapter})</li>`).join('')}</ul></div>
                        </div>
                      `;
                  });
              });

              document.getElementById('create-test-form').addEventListener('submit', e => {
                  e.preventDefault();
                  const selectedSyllabus = {};
                  document.querySelectorAll('.chapter-checkbox:checked').forEach(checkedCb => {
                      const { subject, chapter } = checkedCb.dataset;
                      if (!selectedSyllabus[subject]) selectedSyllabus[subject] = [];
                      selectedSyllabus[subject].push(chapter);
                  });

                  if (Object.keys(selectedSyllabus).length === 0) {
                      alert('Please select at least one chapter.');
                      return;
                  }

                  const topicStatus = [];
                  Object.keys(selectedSyllabus).forEach(subject => {
                      selectedSyllabus[subject].forEach(chapter => {
                          syllabus[subject][chapter].forEach(microtopic => {
                              topicStatus.push({ subject, chapter, microtopic, practiceAttempts: [] });
                          });
                      });
                  });
                  
                  const newTest = {
                      id: crypto.randomUUID(),
                      name: document.getElementById('test-name').value,
                      date: document.getElementById('test-date').value,
                      syllabus: selectedSyllabus,
                      topicStatus: topicStatus,
                      status: 'Upcoming'
                  };
                  appState.testPlans.push(newTest);
                  saveTestPlans();
                  renderTestPlanner();
                  closeModal();
              });
          });

          document.querySelectorAll('.test-delete-btn, .test-complete-btn, .test-prep-toggle-btn, .test-view-analysis-btn, .test-revise-btn, .test-practice-btn').forEach(btn => {
              btn.addEventListener('click', e => {
                  const testId = e.currentTarget.dataset.testid;
                  const test = appState.testPlans.find(t => t.id === testId);
                  
                  if (e.currentTarget.classList.contains('test-delete-btn')) {
                      if (confirm('Are you sure you want to delete this test?')) {
                          appState.testPlans = appState.testPlans.filter(t => t.id !== testId);
                          saveTestPlans();
                          renderTestPlanner();
                      }
                  } else if (e.currentTarget.classList.contains('test-prep-toggle-btn')) {
                      document.getElementById(`prep-${testId}`).classList.toggle('hidden');
                  } else if (e.currentTarget.classList.contains('test-view-analysis-btn')) {
                      const analysis = test.analysis;
                      const prepHistoryHTML = Object.entries(test.topicStatus.reduce((acc, t) => {
                          if (!acc[t.subject]) acc[t.subject] = {};
                          if (!acc[t.subject][t.chapter]) acc[t.subject][t.chapter] = [];
                          acc[t.subject][t.chapter].push(t);
                          return acc;
                      }, {})).map(([subject, chapters]) => `
                          <div class="mt-2"><h5 class="font-bold text-brand-cyan-500">${subject}</h5>
                          ${Object.entries(chapters).map(([chapter, topics]) => `
                            <div class="pl-4 mt-1"><p class="font-semibold text-sm">${chapter}</p>
                              <ul class="text-xs space-y-1">${topics.map(topic => {
                                const acc = topic.practiceAttempts.length > 0 ? (topic.practiceAttempts.reduce((s, a) => s + a.correctAnswers, 0) / topic.practiceAttempts.reduce((s, a) => s + a.totalQuestions, 0)) * 100 : null;
                                return `<li class="flex justify-between"><span>${topic.microtopic}</span><span>Rev Diff: ${topic.revisionDifficulty || 'N/A'}, Prac Acc: ${acc !== null ? acc.toFixed(0)+'%' : 'N/A'}</span></li>`;
                              }).join('')}</ul>
                            </div>`).join('')}
                          </div>
                      `).join('');
                      showModal(`Analysis: ${test.name}`, `
                        <div class="grid grid-cols-4 gap-4 text-center">
                          <div><p class="text-xs text-gray-400">Score</p><p class="text-lg font-bold">${analysis.marksObtained}/${analysis.totalMarks}</p></div>
                          <div><p class="text-xs text-gray-400">Rank</p><p class="text-lg font-bold">${analysis.rank || 'N/A'}</p></div>
                          <div><p class="text-xs text-gray-400">Percentile</p><p class="text-lg font-bold">${analysis.percentile || 'N/A'}</p></div>
                        </div>
                        <p class="mt-4"><b>Notes:</b> ${analysis.notes}</p>
                        <h4 class="font-semibold mb-2 mt-4">Preparation History</h4>
                        <div class="max-h-60 overflow-y-auto bg-black/20 p-3 rounded-lg">${prepHistoryHTML}</div>
                      `);
                  } else if (e.currentTarget.classList.contains('test-complete-btn')) {
                      showModal(`Analyze: ${test.name}`, `
                        <form id="analysis-form" class="space-y-4">
                          <div class="grid grid-cols-2 gap-4">
                            <div><label>Marks Obtained</label><input type="number" id="marks" required class="w-full bg-black/30 p-2 rounded"></div>
                            <div><label>Total Marks</label><input type="number" id="totalMarks" required class="w-full bg-black/30 p-2 rounded"></div>
                            <div><label>Rank</label><input type="number" id="rank" class="w-full bg-black/30 p-2 rounded"></div>
                            <div><label>Percentile</label><input type="number" id="percentile" step="0.01" class="w-full bg-black/30 p-2 rounded"></div>
                          </div>
                          <div><label>Notes</label><textarea id="notes" class="w-full bg-black/30 p-2 rounded"></textarea></div>
                          <div class="flex justify-end"><button type="submit" class="px-4 py-2 rounded bg-brand-cyan-500 text-black">Save</button></div>
                        </form>
                      `);
                      document.getElementById('analysis-form').addEventListener('submit', ev => {
                          ev.preventDefault();
                          test.status = 'Completed';
                          test.analysis = {
                              marksObtained: parseInt(document.getElementById('marks').value),
                              totalMarks: parseInt(document.getElementById('totalMarks').value),
                              rank: document.getElementById('rank').value ? parseInt(document.getElementById('rank').value) : null,
                              percentile: document.getElementById('percentile').value ? parseFloat(document.getElementById('percentile').value) : null,
                              notes: document.getElementById('notes').value,
                          };
                          saveTestPlans();
                          renderTestPlanner();
                          closeModal();
                      });
                  } else if (e.currentTarget.classList.contains('test-revise-btn') || e.currentTarget.classList.contains('test-practice-btn')) {
                      const { subject, chapter, microtopic } = e.currentTarget.dataset;
                      const topic = test.topicStatus.find(t => t.subject === subject && t.chapter === chapter && t.microtopic === microtopic);

                      if (e.currentTarget.classList.contains('test-revise-btn')) {
                          showModal(`Revise: ${topic.microtopic}`, `
                            <form id="revise-form"><label>Difficulty (1-5)</label><input type="range" id="difficulty" min="1" max="5" value="3" class="w-full"><button type="submit" class="px-4 py-2 mt-4 rounded bg-brand-cyan-500 text-black">Save</button></form>
                          `);
                          document.getElementById('revise-form').addEventListener('submit', ev => {
                              ev.preventDefault();
                              topic.revisionDifficulty = parseInt(document.getElementById('difficulty').value);
                              saveTestPlans();
                              renderTestPlanner();
                              closeModal();
                          });
                      } else { // Practice
                          showModal(`Practice: ${topic.microtopic}`, `
                            <form id="practice-form" class="space-y-2"><label>Total Questions</label><input type="number" id="totalQ" min="1" required class="w-full bg-black/30 p-2 rounded"><label>Correct Answers</label><input type="number" id="correctQ" min="0" required class="w-full bg-black/30 p-2 rounded"><button type="submit" class="px-4 py-2 mt-4 rounded bg-brand-cyan-500 text-black">Save</button></form>
                          `);
                          document.getElementById('practice-form').addEventListener('submit', ev => {
                              ev.preventDefault();
                              topic.practiceAttempts.push({ id: crypto.randomUUID(), totalQuestions: parseInt(document.getElementById('totalQ').value), correctAnswers: parseInt(document.getElementById('correctQ').value) });
                              saveTestPlans();
                              renderTestPlanner();
                              closeModal();
                          });
                      }
                  }
              });
          });
      }

      function attachSettingsListeners() {
          document.getElementById('reset-btn').addEventListener('click', () => {
              if (confirm('Are you sure you want to delete all data? This action is irreversible.')) {
                  appState.tasks = [];
                  appState.testPlans = [];
                  saveTasks();
                  saveTestPlans();
                  alert('All data has been reset.');
                  renderAll();
              }
          });
          document.getElementById('export-btn').addEventListener('click', () => {
              const data = { tasks: appState.tasks, testPlans: appState.testPlans };
              const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `neet-futura-backup-${new Date().toISOString().split('T')[0]}.json`;
              a.click();
              URL.revokeObjectURL(url);
          });
          document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file').click());
          document.getElementById('import-file').addEventListener('change', (e) => {
              const file = e.target.files[0];
              if (!file) return;
              const reader = new FileReader();
              reader.onload = (event) => {
                  try {
                      const data = JSON.parse(event.target.result);
                      if (confirm('This will overwrite all current data. Continue?')) {
                          appState.tasks = data.tasks || [];
                          appState.testPlans = data.testPlans || [];
                          saveTasks();
                          saveTestPlans();
                          alert('Data imported successfully!');
                          renderAll();
                      }
                  } catch (err) {
                      alert('Invalid file format.');
                  }
              };
              reader.readAsText(file);
          });
      }

      // --- 7. NAVIGATION & INITIALIZATION ---
      function navigateTo(pageId, isInitial = false) {
          appState.currentPage = pageId;
          document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
          document.getElementById(`page-${pageId}`).classList.add('active');
          
          document.querySelectorAll('.nav-link').forEach(link => {
              if (link.hash === `#${pageId}`) {
                  link.style.background = 'rgba(0, 239, 255, 0.1)';
                  link.style.boxShadow = '0 0 15px rgba(0, 239, 255, 0.4)';
                  link.style.color = '#00EFFF';
              } else {
                  link.style.background = 'transparent';
                  link.style.boxShadow = 'none';
                  link.style.color = '';
              }
          });
          
          if (!isInitial) {
              window.location.hash = pageId;
          }
      }
      
      function handleThemeToggle() {
        appState.theme = appState.theme === 'dark' ? 'light' : 'dark';
        document.documentElement.classList.toggle('dark', appState.theme === 'dark');
        document.getElementById('theme-toggle').innerHTML = appState.theme === 'dark' ? ICONS.sun : ICONS.moon;
        saveTheme();
      }

      function initApp() {
        loadState();
        
        // Theme setup
        document.documentElement.classList.toggle('dark', appState.theme === 'dark');
        document.getElementById('theme-toggle').innerHTML = appState.theme === 'dark' ? ICONS.sun : ICONS.moon;
        document.getElementById('theme-toggle').addEventListener('click', handleThemeToggle);

        // Navigation setup
        const initialPage = window.location.hash.substring(1) || 'planner';
        document.querySelectorAll('.nav-link').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo(link.hash.substring(1));
            // Close mobile menu on navigation
            document.getElementById('mobile-menu').classList.add('hidden');
          });
        });
        
        // Mobile Menu Toggle
        document.getElementById('mobile-menu-button').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });

        // Render initial content
        renderAll();
        navigateTo(initialPage, true);
      }
      
      // Start the app when the DOM is ready
      document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
